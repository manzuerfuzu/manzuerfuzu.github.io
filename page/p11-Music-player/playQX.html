<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>【音乐播放器】满足而富足-净心</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./fonts/iconfont.css">
    <link rel="stylesheet" type="text/css" media="screen" href="./css/reset.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="./css/player.css" />
    
	<script src="../zi____yuan/jquery.slim.min.js"></script>
	<script src="../zi____yuan/bootstrap.bundle.min.js"></script>
	<script src="../zi____yuan/bootstrap.min.js"></script>
	<script src="../zi____yuan/Bmob-2.2.5.min.js"></script>
	<script src="../zi____yuan/fastclick.js"></script>
	
	<style type="text/css">
		
		
		
		#kcmima,#username,#usermima {
			margin: 20px;
			background-color: #ac4de2;
			width: 80%;
			width: calc(100% - 180px);
			height: 64px;
			border-radius: 2px;
			border: 0;
			font-size: 14px;
			padding-left: 32px;
			padding-right: 32px;
			outline: 0px none;
			outline: 0px;
			color: #ffffff;
			display:block;
			margin:20px auto
			
		}
		
		#btn-cx, #user-mima{
			border: 2px solid #ac4de2;
			border-radius:25px;
			width: 150px;
			height: 50px;
			font-size: 30px;
			/* text-align: center; */
			background-color: #FFFF00;
			color:#ac4de2;
			display:block;
			margin:0 auto
		}
		
		#bianma-mima {
			border: 2px solid #ac4de2;
			border-radius:25px;
			/* width: 150px;
			height: 50px; */
			font-size: 16px;
			/* text-align: center; */
			background-color: #FFFF00;
			color:#ac4de2;
			display:block;
		}
		
		#tishi, #yincang-cx p {
			margin: 20px;
			text-align: center;
			color: #F8F8FF;
		}
		
		.chaxun_li {
			text-align: center;
			color: #F8F8FF;
		}
		
		#yincang-cx {
			margin-top: 50px;
			
		}
		
		#me{
			/* position: relative ; */
			margin-top: 15px;
			
		}
		
		#me h3 {
			text-align: center;
			color: #A9A9A9;
		}
		
		#me h3 span {
			color: #FFD700;
		}
		
	</style>
</head>
<body>
	
		<div id="me">
			<h3 >制作: <span>满足而富足-净心</span></h3>
			<h3 >微信号: <span>2926027350</span></h3>
		</div>
	
	
	
	<div id="yincang-cx" >
		<input type="text" id="username" value="" placeholder="在此输入用户名" />
		<input type="text" id="usermima" value="" placeholder="在此输入密码" />
		<p>在上面输入框中分别输入用户名与密码</p>
		<button type="button" id="user-mima" onclick="userquanxian()">确定</button>
		
		<div id="user-jiazaiTS" style="color: #DC3545;"></div>
		<div id="user-shuchu">
			<!-- 查询列表 -->
			<div class="chaxun__list">
				<ul class="chaxun_content">
					<li class="chaxun_li"></li>	
				</ul>
			</div>
		</div>
		
		<button type="button" id="bianma-mima" onclick="bianmashow()" >按课程编码查询</button>
		
		<div id="yincang" style="display:none;">
		  <h1 id="tishi">请在紫色输入框中输入课程编码,<br>再单击下面【确定】按钮加载播放列表</h1>
		  <div class="group">
			
		    <input type="text" name="kcmima" id="kcmima" value="" autofocus="autofocus" placeholder="请在此输入课程编码" autocomplete="off" />
		  </div>
		
		  <div >
			  <button type="button" id="btn-cx" onclick="cx();">确定</button>
		    
		  </div>
		</div>
		
	</div>
	

	
    <!-- 播放器 -->
    <div class="music-player">
        <!-- audio标签 -->
        <audio class="music-player__audio" ></audio>
        <!-- 播放器主体 -->
        <div class="music-player__main">
            <!-- 模糊背景 -->
            <div class="music-player__blur"></div>
            <!-- 唱片 -->
            <div class="music-player__disc">
                <!-- 唱片图片 -->
                <div class="music-player__image">
                    <img width="100%" src="" alt="">
                </div>
                <!-- 指针 -->
                <div class="music-player__pointer"><img width="100%" src="./images/cd_tou.png" alt=""></div>
            </div>
            <!-- 控件主体 -->
            <div class="music-player__controls">
                <!-- 歌曲信息 -->
                <div class="music__info">
                    <h3 class="music__info--title">...</h3>
                    <p class="music__info--singer">...</p>
                </div>
                <!-- 控件... -->
                <div class="player-control">
                    <div class="player-control__content">
                        <div class="player-control__btns">
                            <div class="player-control__btn player-control__btn--prev"><i class="iconfont icon-prev"></i></div>
                            <div class="player-control__btn player-control__btn--play"><i class="iconfont icon-play"></i></div>
                            <div class="player-control__btn player-control__btn--next"><i class="iconfont icon-next"></i></div>
                            <div class="player-control__btn player-control__btn--mode"><i class="iconfont icon-loop"></i></div>
                        </div>
                        <div class="player-control__volume">
                            <div class="control__volume--icon player-control__btn"><i class="iconfont icon-volume"></i></div>
                            <div class="control__volume--progress progress"></div>
                        </div>
                    </div>
    
                </div>
				
            </div>
			
        </div>
		
		<!-- 歌曲播放进度 -->
		<div class="player-control__content">
		    <div class="player__song--progress progress"></div>
		    <div class="player__song--timeProgess nowTime">00:00</div>
		    <div class="player__song--timeProgess totalTime">00:00</div>
		</div>
		
		<!-- 移动端进度条 -->
		
		<!-- <div class="audio-by-all">
		   <span class="audio-by-now"></span>
		</div>
		<div class="audio-by-text">
			<span class="audio-by-text-now">00:00</span><span class="audio-by-text-all">00:00</span>
		</div> -->
		
		
		
        <!-- 歌曲列表 -->
        <div class="music-player__list">
            <ul class="music__list_content">
                <li class="music__list__item play">123</li>
                <li class="music__list__item">123</li>
                <li class="music__list__item">123</li>
            </ul>
        </div>
    </div>
	
	

    <script src="./js/utill.js"></script>
    <script src="http://www.jq22.com/jquery/jquery-1.10.2.js"></script>
    <script src="./js/player.js"></script>
	
	<script type="text/javascript">
		
		if ('addEventListener' in document) {
			document.addEventListener('DOMContentLoaded', function() {
				FastClick.attach(document.body);
			}, false);
		}
		
		$(function() {
			FastClick.attach(document.body);
		});
		
		Bmob.initialize("d120dedc62382103", "201068");
		// Bmob.debug(true);  //上线后关闭
		
		
		
		// ------------ 用户权限 -----------------------
		function userquanxian(){
			
			$('#user-jiazaiTS').html('查询中，稍等一下下！')
			
			var username = $("#username").val();
			var usermima = $("#usermima").val();
			
			 Bmob.User.login(username,usermima).then(res => {
				// 登录成功后跳转页面
				console.log('成功')
				$('#user-jiazaiTS').html('查询完成,点击下列课程题目即可打开')
				// console.log(res)
				console.log(res.quanxian)
				console.log(res.quanxian_mima)
				console.log(res.mp3QXheMM)
				// $("#user-shuchu").text(res.QXheMM)
				
				//生成播放列表
				
					let _str = '';
					res.mp3QXheMM.forEach((list, i) => {
						// console.log(list)
						// console.log(i)
						var splitlist = list.split(':')
						console.log(splitlist)
						// _str += `<li class="chaxun__list__item">${song.title}</li>`
						_str += `<li class="chaxun_li" id=${splitlist[1]}>${splitlist[0]}</li>`
					});
					$(".chaxun_content").html(_str);
				
				
			   // location.href = "page/mp3player.html";
			 }).catch(err => {
			  console.log(err.error)
			});
		}
		
		// *************** 用户权限 end ************************
		
		
		// ------------------ li点击打开 ------------------------------
		
		// $(".chaxun_li").click(function(){ 
		// 	console.log(this.attr("id"))
		// });
		
		var songlist = [];
		
		$('.chaxun_content').on('click','li',function(){
			console.log($(this).attr("id"))
			var mima = $(this).attr("id")
			
			$('#jiazaiTS').html('加载中，稍等一下下！')
			songlist = [];
			 
			 const query = Bmob.Query('mp3');
			 query.get(mima).then(res => {
			   // console.log(res)
			   console.log('成功')
			   $('#jiazaiTS').html('加载完成！')
			   yincangCX()
			   // 获取mp3这列的数据
			   // console.log(res.mp3)
			  
			   // console.log(res.mp3name)
			   console.log(res.wenzi)
			   songlist = eval('(' + res.wenzi + ')');
			   
			   psAudio(songlist);
			   
			   // body.innerHTML = res.code
			 		  
			 }).catch(err => {
			   console.log(err)
			 })
		})
		
		// ******************** li点击打开 end *************************
		
		
		
		
		
		
		
		// 音频播放---------------------------------------------------
		
		
		
		function cx(){
			
			 const query = Bmob.Query('mp3');
			 query.get(document.getElementById("kcmima").value).then(res => {
			   // console.log(res)
			   console.log('成功')
			   yincangCX()
			   // 获取mp3这列的数据
			   // console.log(res.mp3)
			  
			   // console.log(res.mp3name)
			   console.log(res.wenzi)
			   songlist = eval('(' + res.wenzi + ')');
			   
			   psAudio(songlist);
			   
			   // body.innerHTML = res.code
		  
			 }).catch(err => {
			   console.log(err)
			 })
			 
			  
		}
		
		function yincang() {
			$("#yincang").hide()
		}
		
		function bianmashow() {
			$("#yincang").show()
		}
		
		function yincangCX() {
			$("#yincang-cx").hide()
		}
		
	window.psAudio = function(arr){
		//创建一个音乐播放器的类 单例模式
		
		class Player {
		    constructor() { //类的构造函数
		        //如果类已经有实例了，就返回这个实例
		        if (Player.instance) return Player.instance;
		        //如果没有实例化，就去构造一个实例
		        return this.getInstance(...arguments);
		    }
		
		    //构建实例
		    getInstance() {
		        let instance = new PlayerCreator(...arguments);
		        //让实例可以使用到Player的原型的属性方法
		        // instance.__proto__=Player.prototype;
		        // instance.constructor=Player;
		        //把构建好的实例挂在Player类上
		        Player.instance = instance;
		        return instance;
		    }
		}
		
		
		
		//歌曲信息
		class Musics {
		    //歌曲
		    constructor() {
				
				
		
		
					this.songs = arr
					
					
					
				
		    }
		    //根据索引获取歌曲的方法
		    getSongByNum(index) {
		        return this.songs[index];
		    }
		}
		
		//真正的构建播放器的类
		class PlayerCreator {
		    constructor() {
		        this.audio = document.querySelector('.music-player__audio') // Audio dom元素, 因为很多api都是需要原生audio调用的，所以不用jq获取
		        // this.audio.muted = true; // 控制静音
		        this.audio.volume = 0.8;
		
		        //工具
		        this.util = new Util();
		        this.musics = new Musics(); //歌曲信息
		        this.song_index = 0; // 当前播放的歌曲索引
		        this.loop_mode = 0; // 1 2
		        // 下方歌曲列表容器
		        this.song_list = $('.music__list_content');
		
		        this.render_doms = { //切换歌曲时需要渲染的dom组
		            title: $('.music__info--title'),
		            singer: $('.music__info--singer'),
		            image: $('.music-player__image img'),
		            blur: $('.music-player__blur')
		        }
		        this.ban_dom = { //禁音时需要渲染的dom组
		            control__btn: $('.control__volume--icon')
		        }
		
		        // 时间显示容器
		        this.render_time = {
		            now: $('.nowTime'),
		            total: $('.totalTime')
		        }
		
		        // 唱片
		        this.disc = {
		            image: $('.music-player__image'),
		            pointer: $('.music-player__pointer')
		        };
		        //播放器初始化
		        this.init();
		    }
		    //初始化函数
		    init() {
		        this.renderSongList();
		        this.renderSongStyle();
		        this.bindEventListener();
		    }
		    //生成播放列表
		    renderSongList() {
		        let _str = '';
		        this.musics.songs.forEach((song, i) => {
		            _str += `<li class="music__list__item">${song.title}</li>`
		        });
		        this.song_list.html(_str);
		    }
		
		    //根据歌曲去渲染视图
		    renderSongStyle() {
		        let {
		            title,
		            singer,
		            songUrl,
		            imageUrl
		        } = this.musics.getSongByNum(this.song_index);
		        this.audio.src = songUrl;
		        this.render_doms.title.html(title);
		        this.render_doms.singer.html(singer);
		        this.render_doms.image.prop('src', imageUrl);
		        this.render_doms.blur.css('background-image', 'url("' + imageUrl + '")');
		
		        //切换列表中的item的类名 play
		        this.song_list.find('.music__list__item').eq(this.song_index).addClass('play').siblings().removeClass('play');
		    }
		    //绑定各种事件
		    bindEventListener() {
		        //播放按钮
		        this.$play = new Btns('.player-control__btn--play', {
		            click: this.handlePlayAndPause.bind(this)
		        });
		        //上一首
		        this.$prev = new Btns('.player-control__btn--prev', {
		            click: this.changeSong.bind(this, 'prev')
		        });
		        //下一首
		        this.$next = new Btns('.player-control__btn--next', {
		            click: this.changeSong.bind(this, 'next')
		        });
		        //循环模式
		        this.$mode = new Btns('.player-control__btn--mode', {
		            click: this.changePlayMode.bind(this)
		        });
		        //禁音
		        this.$ban = new Btns('.control__volume--icon', {
		            click: this.banNotes.bind(this)
		        })
		        //列表点击
		        this.song_list.on('click', 'li', (e) => {
		            let index = $(e.target).index();
		            this.changeSong(index);
		        })
		
		        //音量控制 audio标签音量 vlouem 属性控制0-1
		
		        new Progress('.control__volume--progress', {
		            min: 0,
		            max: 1,
		            value: this.audio.volume,
		            handler: (value) => { //更改进度时
		                this.audio.volume = value;
		            }
		        })
		
		
		        //歌曲进度 this.audio.duration
		
		        //可以播放的时候触发（歌曲的基本信息都已经获取到了）
		        this.audio.oncanplay = () => {
		            //避免重复实例化
		            if (this.progress) {
		                this.progress.max = this.audio.duration; //切换歌曲后更新时长
		                this.render_time.total.html(this.util.formatTime(this.audio.duration));
		                return false;
		            };
		            this.progress = new Progress('.player__song--progress', {
		                min: 0,
		                max: this.audio.duration,
		                value: 0,
		                handler: (value) => {
		                    this.audio.currentTime = value;
		                }
		            })
		            //调整总时长
		            this.render_time.total.html(this.util.formatTime(this.audio.duration));
		        }
		
		        //会在播放的时候持续触发
		        this.audio.ontimeupdate = () => {
		            this.progress.setValue(this.audio.currentTime);
		            //调整当前时长
		            this.render_time.now.html(this.util.formatTime(this.audio.currentTime));
		        }
		
		        //当歌曲播放完成的时候
		        this.audio.onended = () => {
		            this.changeSong('next');
		            //播放完，换歌后，重新播放
		            this.audio.play();
		        }
		
		    }
		
		    //播放暂停控制
		    handlePlayAndPause() {
		        let _o_i = this.$play.$el.find('i');
		        //this.audio.pauseed值为true 说明目前是不播放
		        if (this.audio.paused) { //现在是暂停的 要播放
		            this.audio.play();
		            _o_i.removeClass('icon-play').addClass('icon-pause');
		            this.disc.image.addClass('play');
		            this.disc.pointer.addClass('play')
		        } else {
		            this.audio.pause();
		            _o_i.addClass('icon-play').removeClass('icon-pause');
		            this.disc.image.removeClass('play');
		            this.disc.pointer.removeClass('play');
		        }
		    }
		
		    //更改循环模式
		    changePlayMode() {
		        this.loop_mode++;
		        if (this.loop_mode > 2) this.loop_mode = 0;
		        this.renderPlayMode();
		    }
		    //更改按钮样式
		    renderPlayMode() {
		        let _classess = ['loop', 'random', 'single'];
		        let _o_i = this.$mode.$el.find('i');
		        //prop 改一些标签的自有属性 attr改一些标签的自定义属性
		        _o_i.prop('class', 'iconfont icon-' + _classess[this.loop_mode])
		    }
		
		    //更改歌曲索引
		    changeSongIndex(type) {
		        if (typeof type === 'number') {
		            this.song_index = type;
		        } else {
		            if (this.loop_mode === 0) {
		                //列表循环
		                this.song_index += type === 'next' ? 1 : -1;
		                if (this.song_index > this.musics.songs.length - 1) this.song_index = 0;
		                if (this.song_index < 0) this.song_index = this.musics.songs.length - 1;
		            } else if (this.loop_mode === 1) {
		                //随机播放
		                let _length = this.musics.songs.length;
		                let _random = Math.floor(Math.random() * _length);
		                for (let i = 0; i < 10000; i++) { //随机的数为本身则继续随机
		                    if (this.song_index == _random) {
		                        _random = Math.floor(Math.random() * _length);
		                    } else {
		                        this.song_index = _random;
		                        break;
		                    }
		                }
		            } else if (this.loop_mode === 2) {
		                this.song_index = this.song_index;
		            }
		        }
		    }
		    //歌曲时长
		    songTime() {
		        let totalMinute = parseInt(this.audio.duration / 60) < 10 ? "0" + parseInt(this.audio.duration / 60) : parseInt(this.audio.duration / 60);
		        let totalSecond = parseInt(this.audio.duration % 60) < 10 ? "0" + parseInt(this.audio.duration % 60) : parseInt(this.audio.duration % 60);
		        $('.totalTime').text(totalMinute + ':' + totalSecond);
		    }
		    //切换歌曲
		    changeSong(type) {
		        //更改索引
		        this.changeSongIndex(type);
		        //记录切歌前的状态
		        let _is_pause = this.audio.paused;
		        //切歌后更改视图显示
		        this.renderSongStyle();
		        //如果切歌前是在播放，就继续播放
		        if (!_is_pause) this.audio.play();
		    }
		    //禁音
		    banNotes() {
		        let _o_i = this.$ban.$el.find("i");
		        if (this.audio.muted == true) { //如果禁音则开启
		            this.audio.muted = false;
		            _o_i.removeClass('icon-muted').addClass('icon-volume');
		        } else {
		            this.audio.muted = true;
		            _o_i.removeClass('icon-volume').addClass('icon-muted');
		        }
		    }
		}
		
		//进度条
		class Progress {
		    constructor(selector, options) {
		        $.extend(this, options);
		        ///给this挂载传入的参数
		        this.$el = $(selector);
		        this.width = this.$el.width();
		        this.init();
		    }
		
		    //进度条初始化
		    init() {
		        this.renderBackAndPointer();
		        //this.bindEvents();
		        this.drag();
		        this.value;
		        this.changeDOMStyle(this.width * this.value);
		    }
		    //为进度条渲染back和pointer
		    renderBackAndPointer() {
		        this.$back = $('<div class="back">');
		        this.$pointer = $('<div class="pointer">');
		
		        this.$el.append(this.$back);
		        this.$el.append(this.$pointer);
		    }
		
		    setValue(value) { //主动调用，传入value值，设置进度条样式
		        let _distance = this.width * value / (this.max - this.min);
		        this.changeDOMStyle(_distance);
		    }
		
		    drag() {
		        let ele = this.$pointer;
		        let father = this.$el;
		        let flag = false; //鼠标是否点击
				// mousedown在移动端不兼容，所以用了touchstart-----------------
		        ele.on('touchstart',(e) => {
				// ele.on("touchstart", function(e) {
				// 	    e.preventDefault();
				// ele.mousedown((e) => {
		            flag = true;
		            let mousePos = {
		                x: e.offsetX
		            }
					$(document).on('touchmove',(e) => {
		            // $(document).mousemove((e) => {
		                if (flag === true) {
		                    let _left = e.clientX - father.offset().left - mousePos.x;
		                    let _distance = Math.max(0, Math.min(_left, father.outerWidth(false) - ele.outerWidth(false)))
		                    let _ratio = _distance / father.outerWidth(false);
		                    let _value = _ratio * (this.max - this.min); //当前的音量值
		                    this.changeDOMStyle(_distance);
		                    this.handler(_value); //更改进度之后，执行回调
		                }
		            })
		        })
				$(document).on('touchend',(e) => {
		        // $(document).mouseup(() => {
		            flag = false;
		        })
		
		    }
		
		    bindEvents() { //鼠标点击时更改
		        this.$el.click((e) => {
		            let _x = e.offsetX; //鼠标距离元素左边的距离
		            let _ratio = _x / this.width;
		            let _value = _ratio * (this.max - this.min); //当前的音量值
		            this.changeDOMStyle(_x);
		            this.handler(_value); //更改进度之后，执行回调
		        })
		    }
		    //更改pointer和back
		    changeDOMStyle(distance) {
		        this.$back.width(distance + 7 == 7 ? 0 : distance + 7);//进度为0时将进度条背景改为0否则加上进度按钮的长度
		        this.$pointer.css('left', distance + 'px');
		    }
		}
		
		
		//按钮类 
		class Btns {
		    constructor(selector, handlers) {
		        this.$el = $(selector); //元素
		        this.bindEvents(handlers);
		    }
		    bindEvents(handlers) { //绑定事件
		        for (const event in handlers) {
		            //使用值的时候保证键值对在对象中是存在的
		            if (handlers.hasOwnProperty(event)) {
		                this.$el.on(event, handlers[event]);
		            }
		        }
		    }
		}
		new Player();
		
		var audio = document.querySelector('.music-player__audio')
		// -+-+-+-+-+-+-+-+-+-+-+-+-+-+
					
					// ++++++++++++++++++++++++++++++++
					
		$('.player__song--progress').on('click',function(event){
			// console.log(event);
			var offset = event.offsetX;
			var current = offset/$(this).width() * audio.duration;
			// console.log(current);
			audio.currentTime = current;
			
		})
	};	
		
		
	</script>
</body>
</html>